# This workflow tests theat the NS fit in main and the one in the PR are consistent

name: Nested Sampling CI

on:
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Config Conda
      shell: bash -l {0}
      run: |
        echo "$NETRC_FILE" | base64 --decode > ~/.netrc
        conda install -n base conda-libmamba-solver
        conda config --set solver libmamba
        conda config --append channels conda-forge
        conda config --prepend channels https://packages.nnpdf.science/public
        conda config --set show_channel_urls true
        conda activate test
        conda install boa --yes
    - name: Install dependencies
      shell: bash -l {0}
      run: |
        conda activate test
        conda install nnpdf -y
        conda install mpi4py -y
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest ultranest jax optax flax flit
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Install colibri and models
      shell: bash -l {0}
      run: |
        conda activate test
        flit install --symlink
        cd colibri/models/wmin
        flit install --symlink
        cd ../grid_pdf
        flit install --symlink
    
    - name: Run grid_pdf NS fit
      shell: bash -l {0}
      run: |
        conda activate test
        grid_pdf colibri/tests/test_runcards/test_grid_pdf_bayes_L0.yaml -o PR_grid_pdf_bayes_L0
    
    - name: Checkout main branch
      uses: actions/checkout@v3
      with:
        ref: main
        clean: false
    
    - name: Run grid_pdf NS fit in main
      shell: bash -l {0}
      run: |
        conda activate test
        grid_pdf colibri/tests/test_runcards/test_grid_pdf_bayes_L0.yaml -o main_grid_pdf_bayes_L0
    
    - name: Compare NS results
      run: |
        # Check if files exist
        if [ -f PR_grid_pdf_bayes_L0/ns_results.csv ] && [ -f main_grid_pdf_bayes_L0/ns_results.csv ]; then
        # Perform the diff only if both files exist
        if diff PR_grid_pdf_bayes_L0/ns_results.csv main_grid_pdf_bayes_L0/ns_results.csv &> /dev/null; then
            echo "Files are identical"
        else
            echo "Files are different"
            exit 1  # Fail the test by exiting with a non-zero code
        fi
        else
        echo "One or both files do not exist"
        exit 1  # Fail the test by exiting with a non-zero code
        fi

